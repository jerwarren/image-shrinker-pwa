<!DOCTYPE html>
<html>
<body>

<div>
    <label for="web-worker">
        Compress in web-worker <span id="web-worker-progress"></span>
        <input id="web-worker" type="file" accept="image/*" onchange="compressImage(event, true);">
    </label>
    <p id="web-worker-log"></p>
</div>


<img id="preview" />

<img id="preview-after-compress" />
<button id="share" onclick="share()" data-url>share</button>
<style>
    table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
    }

    td {
        vertical-align: top;
        width: 50%;
    }

    img {
        max-width: 100%;
    }

    #preview {
      display: none;
    }
</style>


<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/browser-image-compression@1.0.17/dist/browser-image-compression.js"></script>
<script>
  document.querySelector('#version').innerHTML = imageCompression.version
  
  function compressImage (event, useWebWorker) {
    var file = event.target.files[0]
    var logDom, progressDom, downloadLink, filesArray;
    
    logDom = document.querySelector('#web-worker-log')
    progressDom = document.querySelector('#web-worker-progress')
    
    document.getElementById('preview').src = URL.createObjectURL(file)


    logDom.innerHTML = 'Source image size:' + (file.size / 1024 / 1024).toFixed(2) + 'mb'
    console.log('input', file)

    imageCompression.getExifOrientation(file).then(function (o) {
      console.log('ExifOrientation', o)
    })

    var options = {
      maxSizeMB: parseFloat(0.400),
      maxWidthOrHeight: parseFloat(1024),
      useWebWorker: true,
      onProgress: onProgress,
      fileType: "image/jpeg"
    }
    imageCompression(file, options)
      .then(function (output) {
          logDom.innerHTML += ', output size:' + (output.size / 1024 / 1024).toFixed(2) + 'mb'
          console.log('output', output)

          downloadLink = URL.createObjectURL(output)
          logDom.innerHTML += '&nbsp;<a id="result" href="' + downloadLink + '" download="' + file.name + '">download compressed image</a>'
          document.getElementById('preview-after-compress').src = downloadLink;

          var shareFile = new File([output], "picture.jpg", {type: 'image/jpeg'});
          window.filesArray = [shareFile];
          return uploadToServer(output)
      })
      .catch(function (error) {
        alert(error.message)
      })


    function onProgress (p) {
      progressDom.innerHTML = '(' + p + '%' + ')'
    }
  }
  function share(){
    console.log(filesArray)
    navigator.share({
      files: window.filesArray,
      title: 'Shrunk image',
      text: 'Image shrunk to fit within MMS limits',
    })
  }
  
  function uploadToServer (file) {
    // const formData = new FormData()
    // formData.append('image', file, file.name)
    // const url = 'http://localhost:3000/image-upload-api'
    // console.log('calling api', url, 'with data', Array.from(formData.entries())[0])
    // return fetch(url, {
    //   method: 'POST',
    //   body: formData
    // }).then(res => res.json())
    //   .then(body => console.log('got server response', body))
  }
</script>
</body>
</html>
